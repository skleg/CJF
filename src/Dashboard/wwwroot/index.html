<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Job Progress Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 20px; 
      background-color: #f8f9fa;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #2c3e50; 
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    .controls {
      margin: 20px 0;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 5px;
    }
    input, button { 
      padding: 10px 15px; 
      margin: 4px; 
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
    }
    input { 
      width: 300px; 
    }
    button { 
      background: #3498db; 
      color: white; 
      border: none; 
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover { 
      background: #2980b9; 
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px;
      background: white;
      font-size: 14px;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 12px 8px; 
      text-align: left;
    }
    th { 
      background: #34495e; 
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) { 
      background-color: #f8f9fa; 
    }
    tr:hover { 
      background-color: #e8f4f8; 
    }
    .status-started { color: #f39c12; font-weight: bold; }
    .status-completed { color: #27ae60; font-weight: bold; }
    .status-failed { color: #e74c3c; font-weight: bold; }
    .status-cancelled { color: #95a5a6; font-weight: bold; }
    .time-column { font-family: 'Courier New', monospace; }
    .no-records { 
      text-align: center; 
      padding: 40px; 
      color: #7f8c8d; 
      font-size: 16px;
    }
    .job-name-link {
      color: #3498db !important;
      text-decoration: none !important;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .job-name-link:hover {
      color: #2980b9 !important;
      text-decoration: underline !important;
      background-color: #ecf0f1;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Job Progress Dashboard</h1>
    <p>Enter a Job ID to inspect detailed events, or click <em>Recent Jobs</em> to see all activity.</p>
    
    <div class="controls">
      <input id="jobId" placeholder="Enter Job ID (GUID)" />
      <button id="btnFetch">Fetch Job Details</button>
      <button id="btnRecent">Show Recent Jobs</button>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    const output = document.getElementById('output');
    
    // Function to fetch job details when clicking on job name
    async function fetchJobDetails(jobId) {
      try {
        const res = await fetch(`/api/jobs/${encodeURIComponent(jobId)}`);
        const data = await res.json();
        renderTable(data, 'Job Details');
        // Update the input field with the clicked job ID
        document.getElementById('jobId').value = jobId;
      } catch (error) {
        output.innerHTML = '<div class="no-records">Error fetching job details. Please try again.</div>';
      }
    }
    
    document.getElementById('btnFetch').addEventListener('click', async () => {
      const id = document.getElementById('jobId').value.trim();
      if (!id) { 
        alert('Please enter a Job ID'); 
        return; 
      }
      
      try {
        const res = await fetch(`/api/jobs/${encodeURIComponent(id)}`);
        const data = await res.json();
        renderTable(data, 'Job Details');
      } catch (error) {
        output.innerHTML = '<div class="no-records">Error fetching job details. Please try again.</div>';
      }
    });
    
    document.getElementById('btnRecent').addEventListener('click', async () => {
      try {
        const res = await fetch('/api/jobs');
        const data = await res.json();
        renderTable(data, 'Recent Job Activity');
      } catch (error) {
        output.innerHTML = '<div class="no-records">Error fetching recent jobs. Please try again.</div>';
      }
    });
    
    // Event delegation for clicking on job names
    output.addEventListener('click', async (e) => {
      if (e.target.classList.contains('job-name-link')) {
        const jobId = e.target.getAttribute('data-job-id');
        if (jobId) {
          await fetchJobDetails(jobId);
        }
      }
    });
    
    function renderTable(rows, title) {
      if (!rows || rows.length === 0) { 
        output.innerHTML = '<div class="no-records">No records found.</div>'; 
        return; 
      }
      
      let html = `<h3>${title}</h3><table><thead><tr>`;
      const keys = Object.keys(rows[0]);
      
      // Create human-friendly headers
      for (const k of keys) {
        // Skip JobId column in the header for Recent Jobs view, but keep it for Job Details
        if (k === 'JobId' && title === 'Recent Job Activity') continue;
        
        const header = k.charAt(0).toUpperCase() + k.slice(1);
        html += `<th>${header}</th>`;
      }
      html += '</tr></thead><tbody>';
      
      // Render rows with enhanced formatting
      for (const r of rows) { 
        html += '<tr>'; 
        for (const k of keys) {
          // Skip JobId column in Recent Jobs view, but keep it for Job Details
          if (k === 'JobId' && title === 'Recent Job Activity') continue;
          
          let value = r[k] ?? '';
          let cellClass = '';
          
          // Add special formatting for status column
          if (k.toLowerCase() === 'status') {
            const status = value.toLowerCase();
            if (status.includes('started')) cellClass = 'status-started';
            else if (status.includes('completed')) cellClass = 'status-completed';
            else if (status.includes('failed')) cellClass = 'status-failed';
            else if (status.includes('cancelled')) cellClass = 'status-cancelled';
          }
          
          // Add special formatting for time column
          if (k.toLowerCase() === 'time') {
            cellClass += ' time-column';
          }
          
          // Make JobName clickable in Recent Jobs view
          if (k === 'JobName' && title === 'Recent Job Activity' && r.JobId) {
            value = `<span class="job-name-link" data-job-id="${r.JobId}" title="Click to view job details">ðŸ“‹ ${value}</span>`;
          }
          
          html += `<td class="${cellClass}">${value}</td>`;
        }
        html += '</tr>'; 
      }
      html += '</tbody></table>';
      output.innerHTML = html;
    }
  </script>
</body>
</html>